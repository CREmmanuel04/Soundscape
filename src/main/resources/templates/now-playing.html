<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>Now Playing - Soundscape</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <style>
        /* --- GLOBAL & HEADER STYLES --- */
        body {
            font-family: 'Poppins', sans-serif; /* Updated to match other pages */
            background: #121212;
            color: white;
            margin: 0;
            padding: 0; /* Removed padding so header touches the top */
        }

        .header {
            background-color: #1E1E1E;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #2a2a2a;
        }

        .header-logo a {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            text-decoration: none;
        }

        .header-logo i {
            color: #1DB954;
        }

        .nav-links a {
            color: #b3b3b3;
            text-decoration: none;
            margin-left: 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            transition: color 0.2s ease;
        }

        .nav-links a:hover {
            color: #1DB954;
        }

        /* --- PLAYER CONTAINER STYLES --- */
        .container {
            max-width: 600px;
            margin: 3rem auto; /* Added top margin for spacing below header */
            padding: 2rem;
            background: var(--surface-color);
            border-radius: 15px;
            text-align: center;
        }

        .track-info {
            margin-top: 2rem;
            padding: 1.5rem;
            background: #333;
            border-radius: 10px;
            font-size: 1.2rem;
        }

        .not-connected {
            padding: 2rem;
            background: #2a2a2a;
            border-radius: 10px;
            margin: 2rem 0;
        }

        .control-btn {
            background: #333;
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease;
        }

        .control-btn:hover {
            background: #444;
        }

        .control-btn i {
            font-size: 1rem;
        }

        #playPauseBtn {
            background: #1DB954;
            width: 50px;
            height: 50px;
        }

        #playPauseBtn:hover {
            background: #1ed760;
        }

        /* --- LIKED SONGS & PLAYLIST STYLES --- */
        /* Playlist Section Styles */
        .playlists-container {
            margin-top: 2rem;
            text-align: left;
        }

        .playlist-scroll {
            display: flex;
            overflow-x: auto;
            gap: 1rem;
            padding-bottom: 1rem;
        }

        .playlist-scroll::-webkit-scrollbar { height: 8px; }
        .playlist-scroll::-webkit-scrollbar-track { background: #1E1E1E; border-radius: 4px; }
        .playlist-scroll::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        .playlist-scroll::-webkit-scrollbar-thumb:hover { background: #1DB954; }

        .playlist-card {
            min-width: 140px;
            width: 140px;
            background: #2a2a2a;
            padding: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .playlist-card:hover { background: #333; }

        .playlist-card img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .playlist-name {
            font-weight: bold;
            font-size: 0.9rem;
            color: white;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        /* Liked Songs Styles */
        .liked-songs-container {
            margin-top: 2rem;
            background: #2a2a2a;
            border-radius: 15px;
            padding: 1.5rem;
            text-align: left;
        }

        .song-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 1rem;
            scrollbar-width: thin;
            scrollbar-color: #444 #1E1E1E;
        }

        .song-list::-webkit-scrollbar { width: 8px; }
        .song-list::-webkit-scrollbar-track { background: #1E1E1E; border-radius: 4px; }
        .song-list::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        .song-list::-webkit-scrollbar-thumb:hover { background: #1DB954; }

        .song-item {
            display: flex;
            align-items: center;
            padding: 0.8rem;
            border-radius: 8px;
            transition: background 0.2s;
            cursor: pointer;
            border-bottom: 1px solid #333;
        }

        .song-item:hover { background: #333; }

        .song-item img {
            width: 50px;
            height: 50px;
            border-radius: 4px;
            margin-right: 1rem;
        }

        .song-details { flex-grow: 1; }

        .song-title {
            font-weight: bold;
            color: white;
            font-size: 0.95rem;
            margin-bottom: 0.2rem;
        }

        .song-artist {
            color: #b3b3b3;
            font-size: 0.85rem;
        }

        .play-icon-small {
            color: #1DB954;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .song-item:hover .play-icon-small { opacity: 1; }
    </style>

    <!-- Spotify Web Playback SDK -->
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
</head>
<body>

<div th:replace="~{fragments/header :: header}"></div>

<div class="container">
    <div th:if="${connected}">
        <h2 id="playerStatusHeader" style="margin-top: 0;"
            th:text="${trackInfo != null && trackInfo['isRecent'] == 'true'} ? 'Last Played' : 'Now Playing'">
            Now Playing
        </h2>

        <div class="track-info" th:if="${trackInfo.isPlaying == 'true'}">
            <div style="display: flex; align-items: center; gap: 1.5rem; margin-bottom: 2rem; text-align: left;">
                <img th:src="${trackInfo.albumImage}"
                     style="width: 120px; height: 120px; border-radius: 8px; flex-shrink: 0;">
                <div>
                    <h3 style="margin: 0 0 0.3rem 0;" th:text="${trackInfo.trackName}">Track Name</h3>
                    <p style="color: #b3b3b3; margin: 0 0 0.2rem 0;"
                       th:text="${'by ' + trackInfo.artistName}">Artist Name</p>
                    <p style="color: #888; font-size: 0.9rem; margin: 0;"
                       th:text="${'from ' + trackInfo.albumName}">Album Name</p>
                </div>
            </div>

            <div style="border-top: 1px solid #444; padding-top: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <button class="control-btn" id="prevBtn"><i class="fas fa-step-backward"></i></button>
                        <button class="control-btn" id="playPauseBtn"><i class="fas fa-pause"></i></button>
                        <button class="control-btn" id="nextBtn"><i class="fas fa-step-forward"></i></button>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-volume-down" style="color: #b3b3b3;"></i>
                        <input type="range" id="volumeSlider" min="0" max="100" value="50" style="width: 100px; accent-color: #1DB954;">
                        <i class="fas fa-volume-up" style="color: #b3b3b3;"></i>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <span id="currentTime" style="color: #b3b3b3; font-size: 0.8rem; min-width: 40px; line-height: 1;">0:00</span>
                    <div style="flex-grow: 1; position: relative; display: flex; align-items: center;">
                        <input type="range" id="progressBar" min="0" max="100" value="0" style="width: 100%; accent-color: #1DB954; height: 4px;">
                    </div>
                    <span id="totalTime" style="color: #b3b3b3; font-size: 0.8rem; min-width: 40px; line-height: 1;">0:00</span>
                </div>
            </div>
        </div>

        <div class="track-info" th:if="${trackInfo.isPlaying == 'false'}">
            <p>You are currently listening to:</p>
            <h3 style="color: #b3b3b3; font-style: italic;"
                th:text="${trackInfo.trackName}">No track playing</h3>
        </div>

        <div class="playlists-container" th:if="${userPlaylists != null}">
            <h3 style="margin-top: 0; margin-bottom: 1rem;">
                <i class="fas fa-list" style="color: #1DB954;"></i> Your Playlists
            </h3>
            <div class="playlist-scroll">
                <div th:each="playlist : ${userPlaylists}" class="playlist-card"
                     th:data-id="${playlist.id}" onclick="playPlaylist(this.getAttribute('data-id'))">
                    <img th:if="${playlist.images != null && !playlist.images.isEmpty()}"
                         th:src="${playlist.images[0].url}" alt="Playlist">
                    <img th:unless="${playlist.images != null && !playlist.images.isEmpty()}"
                         src="/images/default-playlist.png" alt="Playlist"
                         style="background: #333; display: flex; align-items: center; justify-content: center;">
                    <div class="playlist-name" th:text="${playlist.name}">Playlist Name</div>
                </div>
            </div>
        </div>

        <div class="liked-songs-container" th:if="${likedSongs != null && !likedSongs.isEmpty()}">
            <h3 style="margin-top: 0; border-bottom: 1px solid #444; padding-bottom: 0.5rem;">
                <i class="fas fa-heart" style="color: #1DB954;"></i> Liked Songs
            </h3>

            <div class="song-list">
                <div th:each="song : ${likedSongs}" class="song-item"
                     th:data-uri="${song.uri}" onclick="playTrack(this.getAttribute('data-uri'))">
                    <img th:src="${song.image != '' ? song.image : '/images/default.png'}"
                         alt="Art" onerror="this.style.display='none'">
                    <div class="song-details">
                        <div class="song-title" th:text="${song.name}">Song Title</div>
                        <div class="song-artist" th:text="${song.artist}">Artist</div>
                    </div>
                    <div class="play-icon-small">
                        <i class="fas fa-play-circle fa-2x"></i>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 1rem;">
                <button id="loadMoreBtn" onclick="loadMoreSongs()"
                        style="background: #333; color: white; border: 1px solid #555; padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer;">
                    Load More Songs
                </button>
            </div>
        </div>
    </div>

    <div th:unless="${connected}" class="not-connected">
        <p>Spotify not connected</p>
        <p style="color: #b3b3b3; font-size: 0.9rem;">
            You're logged in but haven't connected Spotify yet.
        </p>
    </div>

</div>

<script>
    let player;
    let progressInterval;
    let currentOffset = 50; // Start loading more from 50

    function startProgressUpdates() {
        if (progressInterval) clearInterval(progressInterval);
        progressInterval = setInterval(() => {
            player.getCurrentState().then(state => {
                if (state) {
                    updateProgressBar(state);
                }
            });
        }, 500);
    }

    function stopProgressUpdates() {
        if (progressInterval) {
            clearInterval(progressInterval);
            progressInterval = null;
        }
    }

    // Spotify Web Playback SDK setup
    window.onSpotifyWebPlaybackSDKReady = () => {
        const token = '[[${user.spotifyAccessToken}]]';

        player = new Spotify.Player({
            name: 'Soundscape Player',
            getOAuthToken: cb => { cb(token); },
            volume: 0.5
        });

        // Ready
        player.addListener('ready', ({ device_id }) => {
            console.log('Ready with Device ID', device_id);
            transferPlayback(device_id, token);

            setTimeout(() => {
                player.getCurrentState().then(state => {
                    if (state && !state.paused) {
                        startProgressUpdates();
                    }
                });
            }, 1000);
        });

        // Player state changes
        player.addListener('player_state_changed', state => {
            if (!state) {
                stopProgressUpdates();
                return;
            }

            updatePlayerUI(state);
            updateProgressBar(state);

            if (!state.paused) {
                startProgressUpdates();
            } else {
                stopProgressUpdates();
            }
        });

        player.connect();

        // Button listeners
        document.getElementById('playPauseBtn').addEventListener('click', () => {
            player.togglePlay();
        });
        document.getElementById('nextBtn').addEventListener('click', () => {
            player.nextTrack();
        });
        document.getElementById('prevBtn').addEventListener('click', () => {
            player.previousTrack();
        });
        document.getElementById('volumeSlider').addEventListener('input', (e) => {
            player.setVolume(e.target.value / 100);
        });
    };

    function transferPlayback(deviceId, token) {
        fetch('https://api.spotify.com/v1/me/player', {
            method: 'PUT',
            headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
            body: JSON.stringify({ device_ids: [deviceId], play: false })
        });
    }

    function updatePlayerUI(state) {
        const playPauseBtn = document.getElementById('playPauseBtn');
        const playPauseIcon = playPauseBtn.querySelector('i');
        const header = document.getElementById('playerStatusHeader');

        if (state.paused) {
            playPauseIcon.className = 'fas fa-play';
        } else {
            playPauseIcon.className = 'fas fa-pause';
            // Auto-update header text to "Now Playing" when music starts
            if (header) {
                header.textContent = "Now Playing";
            }
        }
        updateTrackInfo(state.track_window.current_track);
    }

    function updateTrackInfo(track) {
        if (!track) return;
        const trackNameEl = document.querySelector('.track-info h3');
        if (trackNameEl) trackNameEl.textContent = track.name;

        const artistNameEl = document.querySelector('.track-info p[style*="color: #b3b3b3"]');
        if (artistNameEl && track.artists.length > 0) {
            artistNameEl.textContent = 'by ' + track.artists[0].name;
        }

        const albumImageEl = document.querySelector('.track-info img');
        if (albumImageEl && track.album.images.length > 0) {
            albumImageEl.src = track.album.images[0].url;
        }
    }

    function updateProgressBar(state) {
        if (!state) return;
        const progressBar = document.getElementById('progressBar');
        const currentTimeEl = document.getElementById('currentTime');
        const totalTimeEl = document.getElementById('totalTime');

        const currentTime = state.position;
        const duration = state.duration;
        const progress = (currentTime / duration) * 100;

        progressBar.value = progress;
        currentTimeEl.textContent = formatTime(currentTime);
        totalTimeEl.textContent = formatTime(duration);
    }

    function formatTime(ms) {
        const minutes = Math.floor(ms / 60000);
        const seconds = Math.floor((ms % 60000) / 1000);
        return minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
    }

    // --- Feature Functions ---

    function playTrack(uri) {
        console.log("Playing:", uri);
        const trackId = uri.split(":")[2];
        fetch('/api/spotify/play-track/' + trackId, { method: 'POST' });
    }

    function playPlaylist(playlistId) {
        console.log("Playing playlist:", playlistId);
        fetch('/api/spotify/play-playlist/' + playlistId, { method: 'POST' });
    }

    function loadMoreSongs() {
        const btn = document.getElementById('loadMoreBtn');
        const list = document.querySelector('.song-list');

        btn.textContent = 'Loading...';
        btn.disabled = true;

        fetch('/api/spotify/saved-tracks?offset=' + currentOffset)
            .then(response => response.json())
            .then(songs => {
                if (songs.length === 0) {
                    btn.textContent = 'No more songs';
                    btn.style.display = 'none';
                    return;
                }

                songs.forEach(song => {
                    const div = document.createElement('div');
                    div.className = 'song-item';
                    div.onclick = function() { playTrack(song.uri); };
                    div.innerHTML = `
                        <img src="${song.image}" alt="Art" onerror="this.style.display='none'">
                        <div class="song-details">
                            <div class="song-title">${song.name}</div>
                            <div class="song-artist">${song.artist}</div>
                        </div>
                        <div class="play-icon-small"><i class="fas fa-play-circle fa-2x"></i></div>
                    `;
                    list.appendChild(div);
                });

                currentOffset += songs.length;
                btn.textContent = 'Load More Songs';
                btn.disabled = false;

                if (songs.length < 50) {
                    btn.style.display = 'none';
                }
            })
            .catch(err => {
                console.error(err);
                btn.textContent = 'Error loading songs';
            });
    }
</script>

<!-- âœ… Load header.js LAST so the dropdown works reliably on this page too -->
<th:block th:replace="fragments :: common-scripts"></th:block>

</body>
</html>
